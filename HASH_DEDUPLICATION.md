# 哈希值去重机制说明

## 概述
为了防止留言和计划项在同步时出现重复，系统为每条留言和计划项添加了唯一的哈希值。

## 核心功能

### 1. 哈希值生成 (`generateContentHash`)
- **位置**: `script.js` 第18-28行
- **功能**: 使用内容、用户和时间戳生成16位SHA-256哈希值
- **格式**: `content|user|timestamp` → 16位十六进制字符串

### 2. 留言去重 (`addComment`)
- **位置**: `script.js` 第1375-1405行
- **流程**:
  1. 生成时间戳和哈希值
  2. 检查是否已存在相同哈希的留言
  3. 如果不存在，添加新留言（包含 `_hash` 字段）
  4. 如果已存在，跳过添加（防止重复）

### 3. 计划项去重 (`addPlanItem`)
- **位置**: `script.js` 第1578-1645行
- **流程**:
  1. 生成时间戳和哈希值
  2. 检查是否已存在相同哈希的计划项（跳过已删除的项）
  3. 如果不存在，添加新计划项（对象格式，包含 `_text`, `_hash`, `_timestamp`, `_user`）
  4. 如果已存在，跳过添加（防止重复）

### 4. 同步合并去重 (`sync-firebase.js`)
- **位置**: 
  - 下载合并：`sync-firebase.js` 第313-352行
  - 实时同步：`sync-firebase.js` 第439-492行
- **匹配优先级**:
  1. **哈希值匹配**（最可靠，用于留言和计划项）
  2. ID匹配（自定义项）
  3. `_text`匹配（计划项）
  4. 完整对象匹配（兜底方案）
- **说明**: 下载合并和实时同步都实现了相同的哈希去重逻辑

## 数据结构

### 留言格式
```javascript
{
    user: "mrb" | "djy",
    message: "留言内容",
    timestamp: 1234567890,
    _hash: "abc123def4567890"  // 16位哈希值
}
```

### 计划项格式（新）
```javascript
{
    _text: "计划项内容",
    _hash: "abc123def4567890",  // 16位哈希值
    _timestamp: 1234567890,
    _user: "mrb" | "djy"
}
```

### 计划项格式（旧，兼容）
```javascript
"计划项内容"  // 字符串格式（旧数据）
```

## 渲染兼容性

### 计划项渲染 (`createCard`)
- **位置**: `script.js` 第656-658行
- **逻辑**: 支持新旧两种格式
  - 字符串：直接使用
  - 对象：提取 `_text` 字段

### 计划项过滤 (`createCard`)
- **位置**: `script.js` 第630-644行
- **逻辑**:
  - 已删除的项（`_deleted: true`）不显示
  - 对象格式保留对象本身（不转换为字符串）
  - 字符串格式直接保留

## 同步流程

### 上传
1. 用户添加留言/计划项
2. 系统生成哈希值
3. 检查本地是否已存在（基于哈希值）
4. 如果不存在，保存到 localStorage
5. 自动同步到 Firebase

### 下载/合并
1. 从 Firebase 获取远程数据
2. 与本地数据合并
3. **去重检查**（优先使用哈希值）:
   - 如果远程项的哈希值已存在于本地，跳过添加
   - 如果不存在，添加到合并结果
4. 保存合并后的数据到 localStorage

## 优势

1. **防止重复**: 即使多次同步，相同内容的留言/计划项不会重复
2. **高效匹配**: 哈希值匹配比字符串比较更快
3. **向后兼容**: 支持旧格式数据（字符串格式的计划项）
4. **多设备同步**: 不同设备上的相同内容通过哈希值识别为同一项

## 注意事项

1. **时间戳影响**: 哈希值包含时间戳，所以即使是相同内容，在不同时间添加也会生成不同的哈希值（这是预期的，因为它们是不同的实例）
2. **旧数据**: 旧格式的计划项（字符串）没有哈希值，系统会允许添加（向后兼容）
3. **已删除项**: 已标记为删除的项（`_deleted: true`）不参与去重检查，也不显示

